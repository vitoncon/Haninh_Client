<div class="class-management-container">

  <!-- Statistics Cards - Dashboard Mini -->
  <div class="statistics-cards-grid" *ngIf="!loading && classes.length > 0">
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Tổng lớp học</h6>
          <h4 class="mb-0">{{ classes.length }}</h4>
        </div>
        <div class="icon-container text-blue-500">
          <i class="pi pi-graduation-cap"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Đang diễn ra</h6>
          <h4 class="mb-0">{{ getStatusCount('Đang diễn ra') }}</h4>
        </div>
        <div class="icon-container text-green-500">
          <i class="pi pi-play-circle"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Mở đăng ký</h6>
          <h4 class="mb-0">{{ getStatusCount('Mở đăng ký') }}</h4>
        </div>
        <div class="icon-container text-orange-500">
          <i class="pi pi-calendar-plus"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Hoàn thành</h6>
          <h4 class="mb-0">{{ getStatusCount('Hoàn thành') }}</h4>
        </div>
        <div class="icon-container text-purple-500">
          <i class="pi pi-check-circle"></i>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Main Content -->
  <p-card>
    <!-- Search and Filters Toolbar -->
    <p-toolbar *ngIf="!loading && classes.length > 0">
      <ng-template pTemplate="start">
        <div class="flex items-center gap-2">
          <p-button 
            icon="pi pi-refresh" 
            label="Làm mới" 
            [outlined]="true"
            (click)="onRefresh()"
            [loading]="loading"
            pTooltip="Làm mới danh sách lớp học">
          </p-button>
          <p-button 
            icon="pi pi-filter-slash" 
            [outlined]="true"
            (click)="clearSearch()"
            pTooltip="Xóa tất cả bộ lọc"
            *ngIf="dt && filteredClasses.length > 0">
          </p-button>
        </div>
      </ng-template>
      <ng-template pTemplate="center">
        <div class="flex items-center gap-3">
          <p-iconfield iconPosition="left">
            <p-inputicon class="pi pi-search" />
            <input 
              type="text" 
              pInputText 
              placeholder="Tìm kiếm lớp học..." 
              [(ngModel)]="searchQuery"
              (input)="onGlobalFilter($event)"
              class="search-input"
            />
            <p-inputicon 
              *ngIf="searchQuery" 
              class="pi pi-times clear-search" 
              (click)="clearSearch()"
              pTooltip="Xóa tìm kiếm"
              tooltipPosition="bottom"
            />
          </p-iconfield>
        </div>
      </ng-template>
      <ng-template pTemplate="end">
        <div class="flex items-center gap-2">
          <p-button 
            icon="pi pi-plus" 
            label="Tạo lớp học" 
            class="p-button-primary"
            (click)="onCreate()">
          </p-button>
        </div>
      </ng-template>
    </p-toolbar>
  
    <!-- popup thêm/sửa lớp học -->
    <p-drawer header="Thêm/Sửa lớp học" [(visible)]="drawerVisible"
              position="right"
              (onHide)="onDrawerHide()"
              [modal]="true"
              [style]="{ width: '600px', maxWidth: '90vw' }">
      <div class="class-form-grid p-fluid" *ngIf="formClass">
        
        <!-- Basic Information Section -->
        <div class="form-section">
          <h5 class="form-section-title">Thông tin cơ bản</h5>
          
          <!-- Class Code and Name -->
          <div class="form-row">
            <div class="form-group">
              <label>Mã lớp <span class="req" style="color: #ef4444 !important;">*</span></label>
              <div class="flex gap-2">
                <input 
                  pInputText 
                  [(ngModel)]="formClass.class_code"
                  placeholder="VD: L01"
                  class="flex-1"
                  [readonly]="isEditMode()"
                  [class.readonly-input]="isEditMode()">
                <p-button 
                  *ngIf="!isEditMode()"
                  icon="pi pi-refresh" 
                  (click)="generateNewClassCode()"
                  [outlined]="true"
                  pTooltip="Tạo mã mới"
                  tooltipPosition="top"
                  [loading]="generatingCode">
                </p-button>
              </div>
              <small *ngIf="isEditMode()" class="text-gray-500">Mã lớp không thể thay đổi khi chỉnh sửa</small>
            </div>
            <div class="form-group">
              <label>Tên lớp <span class="req" style="color: #ef4444 !important;">*</span></label>
              <input 
                pInputText 
                [(ngModel)]="formClass.class_name"
                placeholder="VD: Trung Biên Phiên Dịch"
                class="w-full">
            </div>
          </div>

          <!-- Course and Status -->
          <div class="form-row">
            <div class="form-group">
              <label>Khóa học <span class="req" style="color: #ef4444 !important;">*</span></label>
              <p-select 
                [ngModel]="formClass.course_id"
                (ngModelChange)="formClass.course_id = $event"
                [options]="courseOptions"
                optionLabel="label"
                optionValue="value"
                placeholder="Chọn khóa học"
                appendTo="body"
                class="w-full">
                
              </p-select>
            </div>
            <div class="form-group">
              <label>Trạng thái</label>
              <p-select 
                [ngModel]="formClass.status"
                (ngModelChange)="formClass.status = $event"
                [options]="statusOptions"
                placeholder="Chọn trạng thái"
                appendTo="body"
                class="w-full">
              </p-select>
            </div>
          </div>
        </div>

        <!-- Schedule Information Section -->
        <div class="form-section">
          <h5 class="form-section-title">Thông tin lịch học</h5>
          
          <!-- Dates -->
          <div class="form-row">
            <div class="form-group">
              <label>Ngày bắt đầu <span class="req" style="color: #ef4444 !important;">*</span></label>
              <p-datePicker 
                [(ngModel)]="formClass.start_date"
                [showIcon]="true"
                dateFormat="dd/mm/yy"
                appendTo="body"
                [touchUI]="false"
                class="w-full"
                [placeholder]="'dd/mm/yyyy'">
              </p-datePicker>
            </div>
            <div class="form-group">
              <label>Ngày kết thúc <span class="req" style="color: #ef4444 !important;">*</span></label>
              <p-datePicker 
                [(ngModel)]="formClass.end_date"
                [showIcon]="true"
                dateFormat="dd/mm/yy"
                appendTo="body"
                [touchUI]="false"
                class="w-full"
                [placeholder]="'dd/mm/yyyy'">
              </p-datePicker>
            </div>
          </div>

          <!-- Room and Schedule -->
          <div class="form-row">
            <div class="form-group">
              <label>Phòng học</label>
              <input 
                pInputText 
                [(ngModel)]="formClass.room"
                placeholder="VD: P101"
                class="w-full">
            </div>

            <!-- Max Students -->
            <div class="form-group">
              <label>Sĩ số tối đa</label>
              <p-inputNumber 
                [(ngModel)]="formClass.max_students"
                [min]="1"
                [max]="50"
                placeholder="VD: 25"
                class="w-full">
              </p-inputNumber>
            </div>


          </div>
          <div class="form-group schedule-form-group">
            <label>Lịch học</label>
            <div class="schedule-input-container">
              <div class="schedule-days">
                <label class="schedule-label">
                  Thứ trong tuần: 
                  <span class="req" style="color: #ef4444 !important;" *ngIf="!isEditMode()">*</span>
                </label>
                <p-multiSelect
                  [(ngModel)]="selectedDays"
                  [options]="dayOptions"
                  placeholder="Chọn thứ học"
                  optionLabel="label"
                  optionValue="value"
                  appendTo="body"
                  class="w-full"
                  [showToggleAll]="false"
                  [maxSelectedLabels]="0"
                  [selectedItemsLabel]="selectedDays.length + ' ' + vi.selectedDays">
                </p-multiSelect>
              </div>
              
               <div class="schedule-time">
                 <label class="schedule-label">
                   Giờ học: 
                   <span class="req" style="color: #ef4444 !important;" *ngIf="!isEditMode()">*</span>
                 </label>
                 <p-fluid>
                   <div class="flex-auto">
                     <div class="time-inputs">
                       <div class="time-input">
                         <label for="start-time-picker" class="font-bold block mb-2">Từ:</label>
                         <p-datePicker 
                           [(ngModel)]="startTimeDate"
                           [iconDisplay]="'input'"
                           [showIcon]="true"
                           [timeOnly]="true"
                           appendTo="body"
                           inputId="start-time-picker"
                           placeholder="Chọn giờ bắt đầu">
                           <ng-template #inputicon let-clickCallBack="clickCallBack">
                             <i class="pi pi-clock" (click)="clickCallBack($event)"></i>
                           </ng-template>
                         </p-datePicker>
                       </div>
                       <div class="time-separator">-</div>
                       <div class="time-input">
                         <label for="end-time-picker" class="font-bold block mb-2">Đến:</label>
                         <p-datePicker 
                           [(ngModel)]="endTimeDate"
                           [iconDisplay]="'input'"
                           [showIcon]="true"
                           [timeOnly]="true"
                           appendTo="body"
                           inputId="end-time-picker"
                           placeholder="Chọn giờ kết thúc">
                           <ng-template #inputicon let-clickCallBack="clickCallBack">
                             <i class="pi pi-clock" (click)="clickCallBack($event)"></i>
                           </ng-template>
                         </p-datePicker>
                       </div>
                     </div>
                   </div>
                 </p-fluid>
               </div>
              
               <div class="schedule-preview" *ngIf="selectedDays.length > 0 && startTimeDate && endTimeDate">
                <label class="schedule-label">Xem trước:</label>
                <div class="preview-text">
                  {{ getSchedulePreview() }}
                </div>
              </div>
            </div>
          </div>
        </div>


        <!-- Additional Information Section -->
        <div class="form-section">
          <h5 class="form-section-title">Thông tin bổ sung</h5>
          
          <!-- Description -->
          <div class="form-group">
            <label>Mô tả</label>
            <textarea 
              pInputTextarea 
              [(ngModel)]="formClass.description"
              rows="3"
              placeholder="Nhập mô tả lớp học"
              class="w-full">
            </textarea>
          </div>

          <!-- Learning Outcomes -->
          <div class="form-group">
            <label>Chuẩn đầu ra</label>
            <textarea 
              pInputTextarea 
              [(ngModel)]="formClass.learning_outcomes"
              rows="3"
              placeholder="VD: Đạt TOEIC ≥ 500, Giao tiếp cơ bản, Năng lực N3"
              class="w-full">
            </textarea>
          </div>
        </div>
      </div>
      <div class="dialog-actions">
        <button pButton label="Hủy" class="p-button-text" (click)="drawerVisible=false" [disabled]="saving"></button>
        <button pButton label="Lưu" (click)="onSave()" [disabled]="saving || !formClass?.class_code || !formClass?.class_name"></button>
      </div>
    </p-drawer>
  
  
    <!-- main -->
    <main>
      <!-- Loading State -->
      <div *ngIf="loading" class="loading-wrapper">
        <i class="pi pi-spin pi-spinner loading-icon"></i>
        <h3>Đang tải...</h3>
        <p>Vui lòng chờ trong giây lát</p>
      </div>

    <!-- Empty State -->
    <div *ngIf="!loading && classes.length === 0" class="empty-state">
      <i class="pi pi-graduation-cap empty-icon"></i>
      <h3>Không có lớp học</h3>
      <p>
        Hiện tại không có lớp học nào. Hãy tạo lớp học đầu tiên để bắt đầu quản lý!
      </p>
      <button pButton label="Tạo lớp học" icon="pi pi-plus" class="p-button-primary" (click)="onCreate()"></button>
    </div>

    <!-- No Search Results -->
    <div *ngIf="!loading && classes.length > 0 && filteredClasses.length === 0" class="empty-state">
      <i class="pi pi-search empty-icon"></i>
      <h3>Không tìm thấy kết quả</h3>
      <p>
        Không có lớp học nào phù hợp với từ khóa "<strong>{{ searchQuery }}</strong>"
      </p>
      <button pButton label="Xóa tìm kiếm" icon="pi pi-times" class="p-button-outlined" (click)="clearSearch()"></button>
    </div>
      
      <!-- Table -->
      <div *ngIf="!loading && classes.length > 0 && filteredClasses.length > 0">
      <p-table #dt
        [value]="filteredClasses"
        [loading]="loading"
        [paginator]="true"
        [rows]="20"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} lớp học"
        [rowsPerPageOptions]="[10, 20, 50]"
        [globalFilterFields]="['class_code','class_name','course_name','status']"
        responsiveLayout="scroll"
        styleClass="p-datatable-gridlines">

        <!-- Header -->
        <ng-template pTemplate="header">
          <tr>
            <th>Mã lớp</th>
            <th>
              Tên lớp
              <p-columnFilter field="class_name" display="menu" matchMode="contains"></p-columnFilter>
            </th>
            <th>
              Khóa học
              <p-columnFilter field="course_name" display="menu" matchMode="equals"></p-columnFilter>
            </th>
            <th>
              Ngày bắt đầu
              <p-columnFilter field="start_date" display="menu" matchMode="gte"></p-columnFilter>
            </th>
            <th>
              Ngày kết thúc
              <p-columnFilter field="end_date" display="menu" matchMode="lte"></p-columnFilter>
            </th>
            <th>
              Sĩ số tối đa
              <p-columnFilter field="max_students" display="menu" matchMode="equals"></p-columnFilter>
            </th>
            <th>
              Trạng thái
              <p-columnFilter field="status" display="menu" matchMode="equals"></p-columnFilter>
            </th>
            <th>Hành động</th>
          </tr>
        </ng-template>

        <!-- Body -->
        <ng-template pTemplate="body" let-class>
          <tr>
            <td>{{ class.class_code }}</td>
            <td>{{ class.class_name }}</td>
            <td>{{ courseNameById[class.course_id] || class.course_name || '-' }}</td>
            <td>{{ class.start_date | date:'dd/MM/yyyy' }}</td>
            <td>{{ class.end_date | date:'dd/MM/yyyy' }}</td>
            <td>{{ class.max_students }}</td>
            <td>
              <span
                [ngClass]="{
                  'status-open': class.status === 'Mở đăng ký',
                  'status-ongoing': class.status === 'Đang diễn ra',
                  'status-completed': class.status === 'Hoàn thành',
                  'status-cancelled': class.status === 'Đã hủy'
                }"
              >
                {{ class.status }}
              </span>
            </td>
            <td>
              <button
                pButton
                icon="pi pi-eye"
                class="p-button-rounded p-button-text p-button-primary"
                (click)="onView(class)"
              ></button>
              <button
                pButton
                icon="pi pi-pencil"
                class="p-button-rounded p-button-text p-button-info"
                (click)="onEdit(class)"
              ></button>
              <button
                pButton
                icon="pi pi-trash"
                class="p-button-rounded p-button-text p-button-danger"
                (click)="onDelete(class)"
              ></button>
            </td>
          </tr>
        </ng-template>
      </p-table>
      </div>
    </main>
    <p-confirmDialog></p-confirmDialog>
  </p-card>
