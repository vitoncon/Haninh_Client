<div class="teachers-container">
  <!-- Statistics Cards - Dashboard Mini -->
  <div class="statistics-cards-grid" *ngIf="statistics">
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Tổng giảng viên</h6>
          <h4 class="mb-0">{{ statistics.total_teachers }}</h4>
        </div>
        <div class="icon-container text-blue-500">
          <i class="pi pi-users"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Đang dạy</h6>
          <h4 class="mb-0">{{ statistics.active_teachers }}</h4>
        </div>
        <div class="icon-container text-green-500">
          <i class="pi pi-check-circle"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Tạm nghỉ</h6>
          <h4 class="mb-0">{{ statistics.on_leave_teachers }}</h4>
        </div>
        <div class="icon-container text-orange-500">
          <i class="pi pi-clock"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Đã nghỉ</h6>
          <h4 class="mb-0">{{ statistics.inactive_teachers }}</h4>
        </div>
        <div class="icon-container text-red-500">
          <i class="pi pi-times-circle"></i>
        </div>
      </div>
    </p-card>
  </div>
  <!-- Main Content -->
  <p-card>
    <div class="flex justify-content-between align-items-center header-with-buttons">
      <h2 class="m-0">Quản lý giảng viên</h2>
      <div class="flex gap-2 justify-content-end">
        <p-button 
          icon="pi pi-download" 
          label="Xuất Excel" 
          (click)="exportToExcel()"
          [outlined]="true"
          [disabled]="filteredTeachers.length === 0"
          pTooltip="Xuất danh sách giảng viên ra file Excel">
        </p-button>
        <p-button 
          icon="pi pi-refresh" 
          label="Làm mới" 
          (click)="forceRefresh()"
          [outlined]="true"
          [loading]="loading"
          pTooltip="Làm mới danh sách giảng viên">
        </p-button>
        <p-button 
          icon="pi pi-plus" 
          label="Thêm giáo viên" 
          (click)="onCreate()"
          styleClass="p-button-primary">
        </p-button>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="flex flex-wrap gap-3 mb-4">
      <!-- Text Search -->
      <div class="flex-1 min-w-0">
        <p-iconField iconPosition="left">
          <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
          <input 
            pInputText 
            type="text" 
            placeholder="Tìm kiếm ..."
            [value]="searchQuery"
            (input)="onSearch($event)"
            class="w-full">
        </p-iconField>
      </div>
      
      <!-- Department Filter -->
      <div class="min-w-0" style="min-width: 200px;">
        <p-select 
          [ngModel]="filters.department"
          (ngModelChange)="filters.department = $event; onFilterChange()"
          [options]="departmentOptions"
          placeholder="Lọc theo nhiệm vụ"
          [showClear]="true"
          class="w-full">
        </p-select>
      </div>
      
      <!-- Status Filter -->
      <div class="min-w-0" style="min-width: 150px;">
        <p-select 
          [ngModel]="filters.status"
          (ngModelChange)="filters.status = $event; onFilterChange()"
          [options]="statusOptions"
          placeholder="Lọc theo trạng thái"
          [showClear]="true"
          class="w-full">
        </p-select>
      </div>
      
      <!-- Clear Buttons -->
      <div class="flex gap-2">
        <p-button 
          *ngIf="showClearButton || filters.department || filters.status"
          icon="pi pi-times" 
          [text]="true" 
          (click)="onClearFilters()"
          pTooltip="Xóa tất cả bộ lọc">
        </p-button>
        <p-button 
          icon="pi pi-filter" 
          [text]="true" 
          (click)="toggleAdvancedFilters()"
          [label]="showAdvancedFilters ? 'Ẩn bộ lọc nâng cao' : 'Hiện bộ lọc nâng cao'"
          pTooltip="Bộ lọc nâng cao"
          tooltipPosition="bottom"
          styleClass="no-hover-button">
        </p-button>
      </div>
    </div>

    <!-- Advanced Filters Panel -->
    <div *ngIf="showAdvancedFilters" class="advanced-filters-panel mb-4 p-4 bg-gray-50 border border-gray-200 rounded-lg">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Degree Filter -->
        <div class="filter-group">
          <label class="block text-sm font-medium mb-2">Bằng cấp:</label>
          <p-select 
            [ngModel]="filters.degree"
            (ngModelChange)="filters.degree = $event; onFilterChange()"
            [options]="degreeOptions"
            placeholder="Chọn bằng cấp"
            [showClear]="true"
            class="w-full">
          </p-select>
        </div>
        
        <!-- Contract Type Filter -->
        <div class="filter-group">
          <label class="block text-sm font-medium mb-2">Loại hợp đồng:</label>
          <p-select 
            [ngModel]="filters.contractType"
            (ngModelChange)="filters.contractType = $event; onFilterChange()"
            [options]="contractTypeOptions"
            placeholder="Chọn loại hợp đồng"
            [showClear]="true"
            class="w-full">
          </p-select>
        </div>
        
        <!-- Experience Range -->
        <div class="filter-group">
          <label class="block text-sm font-medium mb-2">Kinh nghiệm (năm):</label>
          <div class="flex gap-2">
            <p-inputNumber
              [(ngModel)]="filters.minExperience"
              placeholder="Từ"
              [min]="0"
              [max]="50"
              [useGrouping]="false"
              [allowEmpty]="true"
              (onInput)="onFilterChange()"
              (onBlur)="onFilterChange()"
              class="w-full">
            </p-inputNumber>
            <p-inputNumber
              [(ngModel)]="filters.maxExperience"
              placeholder="Đến"
              [min]="0"
              [max]="50"
              [useGrouping]="false"
              [allowEmpty]="true"
              (onInput)="onFilterChange()"
              (onBlur)="onFilterChange()"
              class="w-full">
            </p-inputNumber>
          </div>
        </div>
        
        <!-- Hire Date Range -->
        <div class="filter-group">
          <label class="block text-sm font-medium mb-2">Ngày tuyển dụng:</label>
          <div class="flex gap-2">
            <p-datePicker 
              [(ngModel)]="filters.hireDateFrom"
              (ngModelChange)="filters.hireDateFrom = $event; onFilterChange()"
              placeholder="Từ ngày"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
              appendTo="body"
              [touchUI]="false"
              class="w-full">
            </p-datePicker>
            <p-datePicker 
              [(ngModel)]="filters.hireDateTo"
              (ngModelChange)="filters.hireDateTo = $event; onFilterChange()"
              placeholder="Đến ngày"
              dateFormat="dd/mm/yy"
              [showIcon]="true"
              appendTo="body"
              [touchUI]="false"
              class="w-full">
            </p-datePicker>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table -->
    <p-table 
      #dt
      [value]="filteredTeachers" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="20"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} giảng viên"
      [rowsPerPageOptions]="[10, 20, 50]"
      [globalFilterFields]="['teacher_code', 'teacher_name', 'department', 'specialization', 'degree', 'status']"
      responsiveLayout="scroll"
      styleClass="p-datatable-gridlines">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th pSortableColumn="teacher_code">
            Mã GV <p-sortIcon field="teacher_code"></p-sortIcon>
          </th>
          <th pSortableColumn="teacher_name">
            Họ tên <p-sortIcon field="teacher_name"></p-sortIcon>
          </th>
          <th pSortableColumn="department">
            Nhiệm vụ <p-sortIcon field="department"></p-sortIcon>
          </th>
          <th pSortableColumn="specialization">
            Chuyên môn <p-sortIcon field="specialization"></p-sortIcon>
          </th>
          <th pSortableColumn="degree">
            Bằng cấp <p-sortIcon field="degree"></p-sortIcon>
          </th>
          <th pSortableColumn="experience_years">
            Kinh nghiệm <p-sortIcon field="experience_years"></p-sortIcon>
          </th>
          <th pSortableColumn="status">
            Trạng thái <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th style="width: 8rem">Thao tác</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-teacher>
        <tr>
          <td>
            <p-tableCheckbox [value]="teacher"></p-tableCheckbox>
          </td>
          <td>
            <div class="flex align-items-center gap-2">
              <p-avatar 
                [image]="teacher.avatar_url" 
                [label]="getLastNameInitial(teacher.teacher_name)" 
                styleClass="mr-2" 
                size="normal" 
                shape="circle">
              </p-avatar>
              <code class="text-sm">{{ teacher.teacher_code }}</code>
            </div>
          </td>
          <td>
            <div class="flex align-items-center gap-2">
              <div>
                <div class="font-semibold">{{ teacher.teacher_name }}</div>
                <div class="text-sm text-gray-600">{{ teacher.email }}</div>
              </div>
            </div>
          </td>
          <td>
            <p-tag 
              [value]="teacher.department || '-'"
              [severity]="getRoleSeverity(teacher.department)">
            </p-tag>
          </td>
          <td>{{ teacher.specialization || '-' }}</td>
          <td>
            <p-tag 
              [value]="teacher.degree" 
              [severity]="getDegreeSeverity(teacher.degree || '')">
            </p-tag>
          </td>
          <td>{{ teacher.experience_years || 0 }} năm</td>
          <td>
            <p-tag 
              [value]="teacher.status" 
              [severity]="getStatusSeverity(teacher.status)">
            </p-tag>
          </td>
          <td>
            <div class="flex gap-2" (click)="$event.stopPropagation()">
              <p-button 
                icon="pi pi-eye" 
                [text]="true" 
                size="small"
                (click)="onView(teacher)"
                pTooltip="Xem chi tiết">
              </p-button>
              <p-button 
                icon="pi pi-pencil" 
                [text]="true" 
                size="small"
                (click)="onEdit(teacher)"
                pTooltip="Chỉnh sửa">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                [text]="true" 
                severity="danger"
                size="small"
                (click)="onDelete(teacher)"
                pTooltip="Xóa">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center">
            <div class="py-4">
              <i class="pi pi-inbox text-4xl mb-2"></i>
              <p>Không có giảng viên nào</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Drawer for Add/Edit -->
  <p-drawer 
    [(visible)]="drawerVisible" 
    [position]="'right'" 
    [style]="{ width: '600px' }"
    [modal]="true">
    
    <ng-template pTemplate="header">
      <h4 class="m-0">{{ formTeacher?.id ? 'Chỉnh sửa giảng viên' : 'Thêm giảng viên mới' }}</h4>
    </ng-template>
    
    <ng-template pTemplate="content">
      <div class="teacher-form-grid p-fluid" *ngIf="formTeacher; else noFormTemplate">
        <!-- Basic Information Section -->
        <div class="form-section">
          <h5 class="form-section-title">Thông tin cơ bản</h5>
          
          <!-- Teacher Code -->
          <div class="form-group">
            <label>Mã giảng viên <span class="req" style="color: #ef4444 !important;">*</span></label>
            <div class="flex gap-2">
              <input 
                pInputText 
                [(ngModel)]="formTeacher.teacher_code"
                placeholder="Nhập mã giảng viên"
                class="flex-1"
                [readonly]="isEditMode()"
                [class.readonly-input]="isEditMode()">
              <p-button 
                *ngIf="!isEditMode()"
                icon="pi pi-refresh" 
                (click)="generateNewCode()"
                [outlined]="true"
                pTooltip="Tạo mã mới"
                tooltipPosition="top">
              </p-button>
            </div>
            <small *ngIf="isEditMode()" class="text-gray-500">Mã giảng viên không thể thay đổi khi chỉnh sửa</small>
          </div>

          <!-- Teacher Name -->
          <div class="form-group">
            <label>Họ và tên <span class="req" style="color: #ef4444 !important;">*</span></label>
            <input 
              pInputText 
              [(ngModel)]="formTeacher.teacher_name"
              placeholder="Nhập họ và tên"
              class="w-full">
          </div>

          <!-- Gender and DOB -->
          <div class="form-row">
            <div class="form-group">
              <label>Giới tính <span class="req" style="color: #ef4444 !important;">*</span></label>
              <p-select 
                [ngModel]="formTeacher.gender"
                (ngModelChange)="formTeacher.gender = $event"
                [options]="genderOptions"
                placeholder="Chọn giới tính"
                class="w-full">
              </p-select>
            </div>
            <div class="form-group">
              <label>Ngày sinh</label>
              <p-datePicker 
                [(ngModel)]="formTeacher.dob"
                [showIcon]="true"
                dateFormat="dd/mm/yy"
                appendTo="body"
                [touchUI]="false"
                class="w-full">
              </p-datePicker>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="form-row">
            <div class="form-group">
              <label>Số điện thoại</label>
              <input 
                pInputText 
                [(ngModel)]="formTeacher.phone"
                placeholder="Nhập số điện thoại"
                class="w-full">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input 
                pInputText 
                [(ngModel)]="formTeacher.email"
                placeholder="Nhập email"
                class="w-full">
            </div>
          </div>

          <!-- Address -->
          <div class="form-group">
            <label>Địa chỉ</label>
            <input 
              pInputText 
              [(ngModel)]="formTeacher.address"
              placeholder="Nhập địa chỉ"
              class="w-full">
          </div>
        </div>

        <!-- Professional Information Section -->
        <div class="form-section">
          <h5 class="form-section-title">Thông tin chuyên môn</h5>
          
          <!-- Department and Specialization -->
          <div class="form-row">
            <div class="form-group">
                <label>Nhiệm vụ <span class="req" style="color: #ef4444 !important;">*</span></label>
                <p-select 
                  [ngModel]="formTeacher.department"
                  (ngModelChange)="formTeacher.department = $event"
                  [options]="departmentOptions"
                  placeholder="Chọn nhiệm vụ"
                  [filter]="true"
                  [showClear]="true"
                  class="w-full">
                </p-select>
              </div>
              <div class="form-group">
                <label>Chuyên môn <span class="text-gray-500">(Tùy chọn)</span></label>
                <p-select
                  [ngModel]="formTeacher.specialization"
                  (ngModelChange)="formTeacher.specialization = $event"
                  [options]="specializationOptions"
                  placeholder="Chọn chuyên môn"
                  [showClear]="true"
                  [filter]="true"
                  class="w-full">
                </p-select>
              </div>
          </div>

          <!-- Degree and Experience -->
          <div class="form-row">
            <div class="form-group">
              <label>Bằng cấp <span class="req" style="color: #ef4444 !important;">*</span></label>
              <p-select 
                [ngModel]="formTeacher.degree"
                (ngModelChange)="formTeacher.degree = $event"
                [options]="degreeOptions"
                placeholder="Chọn bằng cấp"
                class="w-full">
              </p-select>
            </div>
            <div class="form-group">
              <label>Số năm kinh nghiệm</label>
              <p-inputNumber
                [(ngModel)]="formTeacher.experience_years"
                [min]="0"
                [max]="50"
                placeholder="Nhập số năm"
                class="w-full">
              </p-inputNumber>
            </div>
          </div>

          <!-- Languages -->
          <div class="form-group">
            <label>Ngôn ngữ có thể dạy</label>
            <input 
              pInputText 
              [(ngModel)]="formTeacher.languages"
              placeholder="VD: Tiếng Anh, Tiếng Hàn"
              class="w-full">
          </div>

          <!-- Certifications -->
          <div class="form-group">
            <label>Chứng chỉ chuyên môn</label>
            <textarea 
              pInputTextarea 
              [(ngModel)]="formTeacher.certifications"
              rows="3"
              placeholder="Nhập các chứng chỉ chuyên môn"
              class="w-full">
            </textarea>
          </div>
        </div>

        <!-- Employment Information Section -->
        <div class="form-section">
          <h5 class="form-section-title">Thông tin việc làm</h5>
          
          <!-- Status -->
          <div class="form-group">
            <label>Trạng thái <span class="req" style="color: #ef4444 !important;">*</span></label>
            <p-select 
              [ngModel]="formTeacher.status"
              (ngModelChange)="formTeacher.status = $event"
              [options]="statusOptions"
              placeholder="Chọn trạng thái"
              class="w-full">
            </p-select>
          </div>

          <!-- Notes -->
          <div class="form-group">
            <label>Ghi chú</label>
            <textarea 
              pInputTextarea 
              [(ngModel)]="formTeacher.note"
              rows="3"
              placeholder="Nhập ghi chú"
              class="w-full">
            </textarea>
          </div>
        </div>

        <!-- Advanced Information Section (Available after migration) -->
        <div class="form-section" *ngIf="true"> <!-- Đã có migration -->
          <h5 class="form-section-title">Thông tin nâng cao</h5>
          
          <!-- Status and Contract Type -->
          <div class="form-row">
            <div class="form-group">
              <label>Trạng thái <span class="req" style="color: #ef4444 !important;">*</span></label>
              <p-select 
                [ngModel]="formTeacher.status"
                (ngModelChange)="formTeacher.status = $event"
                [options]="statusOptions"
                placeholder="Chọn trạng thái"
                class="w-full">
              </p-select>
            </div>
            <div class="form-group">
              <label>Loại hợp đồng</label>
              <p-select 
                [ngModel]="formTeacher.contract_type"
                (ngModelChange)="formTeacher.contract_type = $event"
                [options]="contractTypeOptions"
                placeholder="Chọn loại hợp đồng"
                class="w-full">
              </p-select>
            </div>
          </div>

          <!-- Hire Date and Teaching Hours -->
          <div class="form-row">
            <div class="form-group">
              <label>Ngày tuyển dụng</label>
              <p-datePicker 
                [(ngModel)]="formTeacher.hire_date"
                [showIcon]="true"
                dateFormat="dd/mm/yy"
                appendTo="body"
                [touchUI]="false"
                class="w-full">
              </p-datePicker>
            </div>
            <div class="form-group">
              <label>Số giờ dạy/tuần</label>
              <p-inputNumber
                [(ngModel)]="formTeacher.teaching_hours_per_week"
                [min]="0"
                [max]="60"
                placeholder="Nhập số giờ"
                class="w-full">
              </p-inputNumber>
            </div>
          </div>

          <!-- Salary -->
          <div class="form-group">
            <label>Lương cơ bản</label>
            <p-inputNumber
              [(ngModel)]="formTeacher.salary"
              [min]="0"
              [maxFractionDigits]="0"
              placeholder="Nhập lương cơ bản"
              class="w-full">
            </p-inputNumber>
          </div>

          <!-- Avatar Upload -->
          <div class="form-group">
            <label>Hình đại diện</label>
            <p-fileUpload 
              mode="basic" 
              name="avatar" 
              accept="image/*" 
              [maxFileSize]="1000000"
              chooseLabel="Chọn hình"
              chooseIcon="pi pi-upload"
              (onError)="onFileUploadError($event)"
              (onSelect)="onFileUploadSelect($event)"
              (onBeforeUpload)="onFileUploadBeforeUpload($event)"
              class="w-full">
            </p-fileUpload>
          </div>
        </div>
        
        <!-- Dialog Actions -->
        <div class="dialog-actions flex justify-content-end align-items-center gap-3 w-full"
             style="display: flex; justify-content: flex-end; width: 100%; margin-top: 1rem;">
          <button 
            pButton 
            label="Hủy" 
            class="p-button-text" 
            (click)="onDrawerHide()"
            [disabled]="saving">
          </button>
          <button 
            pButton 
            label="{{ formTeacher.id ? 'Cập nhật' : 'Thêm mới' }}" 
            (click)="onSave()"
            [disabled]="saving || !formTeacher.teacher_code || !formTeacher.teacher_name">
          </button>
        </div>
      </div>
      
      <!-- Fallback template when formTeacher is null -->
      <ng-template #noFormTemplate>
        <div style="padding: 20px; text-align: center;">
          <p>Form đang được khởi tạo...</p>
          <p-button 
            label="Tạo form mới" 
            (click)="onCreate()"
            [loading]="!formTeacher">
          </p-button>
        </div>
      </ng-template>
    </ng-template>
  </p-drawer>
</div>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>