<div class="certificates-container">
  <!-- Statistics Cards - Dashboard Mini -->
  <div class="statistics-cards-grid" *ngIf="statistics">
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Tổng chứng chỉ</h6>
          <h4 class="mb-0">{{ statistics.total_certificates }}</h4>
        </div>
        <div class="icon-container text-blue-500">
          <i class="pi pi-crown"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Đã cấp</h6>
          <h4 class="mb-0">{{ statistics.issued_certificates }}</h4>
        </div>
        <div class="icon-container text-green-500">
          <i class="pi pi-check-circle"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Hết hạn</h6>
          <h4 class="mb-0">{{ statistics.expired_certificates }}</h4>
        </div>
        <div class="icon-container text-orange-500">
          <i class="pi pi-clock"></i>
        </div>
      </div>
    </p-card>
    <p-card>
      <div class="flex align-items-center">
        <div class="flex-1">
          <h6>Chờ cấp</h6>
          <h4 class="mb-0">{{ statistics.pending_certificates }}</h4>
        </div>
        <div class="icon-container text-purple-500">
          <i class="pi pi-hourglass"></i>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Main Content -->
  <p-card>
    <div class="flex justify-content-between align-items-center mb-4">
      <h2 class="m-0">Quản lý chứng chỉ</h2>
      <div class="flex gap-2">
        <p-button 
          icon="pi pi-download" 
          label="Xuất CSV" 
          (click)="exportToCSV()"
          [outlined]="true"
          [disabled]="certificates.length === 0"
          pTooltip="Xuất danh sách chứng chỉ ra file CSV">
        </p-button>
        <p-button 
          icon="pi pi-refresh" 
          label="Làm mới" 
          (click)="forceRefresh()"
          [outlined]="true"
          [loading]="loading"
          pTooltip="Làm mới danh sách chứng chỉ">
        </p-button>
        <p-button 
          icon="pi pi-plus" 
          label="Thêm chứng chỉ" 
          (click)="openNew()"
          styleClass="p-button-primary">
        </p-button>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="flex flex-wrap gap-3 mb-4">
      <!-- Text Search -->
      <div class="flex-1 min-w-0">
        <p-iconField iconPosition="left">
          <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
          <input 
            pInputText 
            type="text" 
            placeholder="Tìm kiếm chứng chỉ..."
            [value]="searchQuery"
            (input)="onSearch($event)"
            class="w-full">
        </p-iconField>
      </div>
      
      <!-- Class Filter -->
      <div class="min-w-0" style="min-width: 250px;">
        <p-select 
          [ngModel]="selectedClassFilter"
          (ngModelChange)="selectedClassFilter = $event; onClassFilterChange()"
          [options]="availableClasses"
          placeholder="Tất cả lớp học"
          [filter]="true"
          class="w-full">
        </p-select>
      </div>
      
      <!-- Expiry Date Filter -->
      <div class="min-w-0" style="min-width: 250px;">
        <p-select 
          [ngModel]="selectedExpiryFilter"
          (ngModelChange)="selectedExpiryFilter = $event; onExpiryFilterChange()"
          [options]="expirySearchOptions"
          placeholder="Lọc theo thời hạn"
          [filter]="true"
          class="w-full">
        </p-select>
      </div>
      
      <!-- Custom Date Range (shown when custom_range is selected) -->
      <div *ngIf="selectedExpiryFilter === 'custom_range'" class="flex gap-2 min-w-0">
        <p-datePicker 
          [ngModel]="customDateRange.from"
          (ngModelChange)="customDateRange.from = $event; onCustomDateRangeChange()"
          placeholder="Từ ngày"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          class="w-full"
          style="min-width: 150px;">
        </p-datePicker>
        <p-datePicker 
          [ngModel]="customDateRange.to"
          (ngModelChange)="customDateRange.to = $event; onCustomDateRangeChange()"
          placeholder="Đến ngày"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          class="w-full"
          style="min-width: 150px;">
        </p-datePicker>
      </div>
      
      <!-- Clear Buttons -->
      <div class="flex gap-2">
        <p-button 
          *ngIf="showClearButton || selectedExpiryFilter"
          icon="pi pi-times" 
          [text]="true" 
          (click)="clearSearch(); clearExpiryFilter()"
          pTooltip="Xóa tất cả bộ lọc">
        </p-button>
      </div>
    </div>

    <!-- Data Table -->
    <p-table 
      #dt
      [value]="filteredCertificates" 
      [loading]="loading"
      [paginator]="true" 
      [rows]="20"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} chứng chỉ"
      [rowsPerPageOptions]="[10, 20, 50]"
      [globalFilterFields]="['student_name', 'certificate_name', 'certificate_number', 'status']"
      responsiveLayout="scroll"
      styleClass="p-datatable-gridlines">
      
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 3rem">
            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
          </th>
          <th pSortableColumn="student_name">
            Học viên <p-sortIcon field="student_name"></p-sortIcon>
          </th>
          <th pSortableColumn="certificate_name">
            Chứng chỉ <p-sortIcon field="certificate_name"></p-sortIcon>
          </th>
          <th pSortableColumn="certificate_number">
            Số chứng chỉ <p-sortIcon field="certificate_number"></p-sortIcon>
          </th>
          <th pSortableColumn="issued_date">
            Ngày cấp <p-sortIcon field="issued_date"></p-sortIcon>
          </th>
          <th pSortableColumn="expiry_date">
            Ngày hết hạn <p-sortIcon field="expiry_date"></p-sortIcon>
          </th>
          <th pSortableColumn="status">
            Trạng thái <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th style="width: 8rem">Thao tác</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-certificate>
        <tr>
          <td>
            <p-tableCheckbox [value]="certificate"></p-tableCheckbox>
          </td>
          <td>
            <div class="flex align-items-center gap-2">
              <div>
                <div class="font-semibold">{{ certificate.student_name }}</div>
                <div class="text-sm">{{ certificate.student_code }}</div>
              </div>
            </div>
          </td>
          <td>
            <div>
              <div class="font-semibold">{{ certificate.certificate_name }}</div>
              <div class="text-sm">{{ certificate.certificate_code }}</div>
              <div class="text-xs" *ngIf="certificate.is_permanent !== undefined">
                {{ isPermanentToString(certificate.is_permanent) }}
              </div>
            </div>
          </td>
          <td>
            <code class="text-sm">{{ certificate.certificate_number }}</code>
          </td>
          <td>{{ formatDate(certificate.issued_date) }}</td>
          <td>
            <div *ngIf="certificate.expiry_date; else noExpiry">
              {{ formatDate(certificate.expiry_date) }}
              <div class="text-xs mt-1" 
                   [ngClass]="{
                     'text-red-600': isCertificateExpired(certificate.expiry_date),
                     'text-orange-600': !isCertificateExpired(certificate.expiry_date) && getDaysUntilExpiry(certificate.expiry_date) <= 30,
                     'text-green-600': !isCertificateExpired(certificate.expiry_date) && getDaysUntilExpiry(certificate.expiry_date) > 30
                   }">
                <span *ngIf="isCertificateExpired(certificate.expiry_date)">Đã hết hạn</span>
                <span *ngIf="!isCertificateExpired(certificate.expiry_date) && getDaysUntilExpiry(certificate.expiry_date) <= 30">
                  Còn {{ getDaysUntilExpiry(certificate.expiry_date) }} ngày
                </span>
                <span *ngIf="!isCertificateExpired(certificate.expiry_date) && getDaysUntilExpiry(certificate.expiry_date) > 30">
                  Còn {{ getDaysUntilExpiry(certificate.expiry_date) }} ngày
                </span>
              </div>
            </div>
            <ng-template #noExpiry>
              <span>Vĩnh viễn</span>
            </ng-template>
          </td>
          <td>
            <p-tag 
              [value]="certificate.status" 
              [severity]="getStatusSeverity(certificate.status)">
            </p-tag>
          </td>
          <td>
            <div class="flex gap-2">
              <p-button 
                icon="pi pi-pencil" 
                [text]="true" 
                size="small"
                (click)="editCertificate(certificate)"
                pTooltip="Chỉnh sửa">
              </p-button>
              <p-button 
                icon="pi pi-trash" 
                [text]="true" 
                severity="danger"
                size="small"
                (click)="deleteCertificate(certificate)"
                pTooltip="Xóa">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center">
            <div class="empty-state">
              <i class="pi pi-inbox empty-icon"></i>
              <p class="empty-text">Không có chứng chỉ nào</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Drawer for Add/Edit -->
  <p-drawer 
    [(visible)]="drawerVisible" 
    [position]="'right'" 
    [style]="{ width: '700px' }"
    [modal]="true"
    styleClass="certificate-drawer">
    
    <ng-template pTemplate="header">
      <h4 class="m-0">{{ isEditMode ? 'Chỉnh sửa chứng chỉ' : 'Thêm chứng chỉ mới' }}</h4>
    </ng-template>
    
    <ng-template pTemplate="content">
      <div class="certificate-form p-fluid" *ngIf="formCertificate; else noFormTemplate">
        <div class="form-card">
          <!-- Row 1: Class và Certificate Type -->
          <div class="form-row">
          <div class="field">
            <label>Lớp học <span class="required">*</span></label>
            <p-select 
              id="class_id"
              name="class_id"
              [ngModel]="isEditMode ? formCertificate.class_id : selectedClassId" 
              (ngModelChange)="onClassSelectionChange($event)"
              [options]="availableClasses"
              placeholder="Chọn lớp học"
              [filter]="true"
              filterBy="label"
              class="w-full"
              [required]="true"
              [disabled]="isEditMode">
            </p-select>
            <small *ngIf="isEditMode" class="text-gray-500">Lớp học không thể thay đổi khi chỉnh sửa</small>
          </div>
          
          <div class="field">
            <label>Loại chứng chỉ <span class="required">*</span></label>
            <p-select 
              id="certificate_id"
              name="certificate_id"
              [ngModel]="formCertificate.certificate_id" 
              (ngModelChange)="formCertificate && (formCertificate.certificate_id = $event); onCertificateTypeChange($event)"
              [options]="availableCertificateTypes"
              placeholder="Chọn loại chứng chỉ"
              [filter]="true"
              filterBy="label"
              class="w-full"
              [required]="true">
            </p-select>
          </div>
        </div>

        <!-- Row 2: Student Selection (full width) -->
        <div class="form-row full-width" *ngIf="!isEditMode && selectedClassId">
          <div class="field">
            <label>Học viên trong lớp <span class="required">*</span></label>
            <p-multiSelect 
              id="student_ids"
              name="student_ids"
              [ngModel]="isEditMode ? [formCertificate.student_id] : selectedStudentIds" 
              (ngModelChange)="onStudentSelectionChange($event)"
              [options]="availableStudentsInClass"
              placeholder="Chọn học viên để cấp chứng chỉ"
              [filter]="true"
              [showClear]="true"
              class="w-full"
              [required]="true"
              [maxSelectedLabels]="0"
              [selectedItemsLabel]="(isEditMode ? [formCertificate.student_id] : selectedStudentIds).length + ' ' + vi.selectedItems"
              [disabled]="isEditMode">
            </p-multiSelect>
            <small *ngIf="isEditMode" class="text-gray-500">Học viên không thể thay đổi khi chỉnh sửa</small>
          </div>
        </div>

        <!-- Row 3: Certificate Number và Status -->
        <div class="form-row">
          <div class="field">
            <label for="certificate_number">Số chứng chỉ <span class="required">*</span></label>
            <input 
              pInputText 
              id="certificate_number"
              name="certificate_number"
              [ngModel]="getCertificateNumberDisplay()"
              [readonly]="selectedStudentIds.length > 1"
              placeholder="Nhập số chứng chỉ"
              class="w-full">
          </div>
          
          <div class="field">
            <label>Trạng thái <span class="required">*</span></label>
            <p-select 
              id="status"
              name="status"
              [ngModel]="formCertificate.status" 
              (ngModelChange)="formCertificate && (formCertificate.status = $event)"
              [options]="certificateStatusOptions"
              placeholder="Chọn trạng thái"
              class="w-full">
            </p-select>
          </div>
        </div>

        <!-- Row 4: Issued Date và Expiry Date -->
        <div class="form-row">
          <div class="field">
            <label>Ngày cấp <span class="required">*</span></label>
            <p-datePicker 
              id="issued_date"
              name="issued_date"
              [ngModel]="formCertificate.issued_date"
              (ngModelChange)="formCertificate && (formCertificate.issued_date = $event); onIssuedDateChange()"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              class="w-full">
            </p-datePicker>
          </div>
          
          <div class="field">
            <label>Ngày hết hạn</label>
            <p-datePicker 
              id="expiry_date"
              name="expiry_date"
              [ngModel]="formCertificate.expiry_date"
              (ngModelChange)="formCertificate && (formCertificate.expiry_date = $event)"
              [showIcon]="true"
              dateFormat="dd/mm/yy"
              class="w-full"
              [disabled]="currentCertificateTypeDetails?.isPermanent">
            </p-datePicker>
          </div>
        </div>

        <!-- Row 5: Issued By (full width) -->
        <div class="form-row full-width">
          <div class="field">
            <label for="issued_by">Người cấp</label>
            <input 
              pInputText 
              id="issued_by"
              name="issued_by"
              [ngModel]="formCertificate.issued_by"
              (ngModelChange)="formCertificate && (formCertificate.issued_by = $event)"
              placeholder="Nhập tên người cấp"
              class="w-full">
          </div>
        </div>
        </div>

        <!-- Actions -->
        <div class="form-actions">
          <button 
            pButton 
            label="Hủy" 
            class="p-button-text" 
            (click)="cancelEdit()"
            [disabled]="saving">
          </button>
          <button 
            pButton 
            [label]="getSaveButtonLabel()" 
            (click)="saveCertificate()"
            [disabled]="saving || !canSave()"
            [loading]="saving">
          </button>
        </div>
      </div>
      
      <!-- Fallback template when formCertificate is null -->
      <ng-template #noFormTemplate>
        <div style="padding: 20px; text-align: center;">
          <p>Form đang được khởi tạo...</p>
          <p-button 
            label="Tạo form mới" 
            (click)="openNew()"
            [loading]="!formCertificate">
          </p-button>
        </div>
      </ng-template>
    </ng-template>
  </p-drawer>
</div>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
